name: CI

on:
  push:
    branches: [main, staging, develop]
  pull_request:
    branches: [main, staging]

env:
  NODE_VERSION: "24.12.0"
  PNPM_VERSION: "10.29.2"

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # ─────────────────────────────────────────
  # STAGE 1 — Code Quality Gate
  # ─────────────────────────────────────────
  quality:
    name: Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check formatting (Prettier)
        run: pnpm format:check

      - name: Lint (ESLint)
        run: pnpm lint

      - name: Type check (TypeScript)
        run: pnpm tsc --noEmit

      - name: Run tests with coverage
        run: pnpm test --coverage --run
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

      # Posts a coverage summary comment on the PR
      - name: Report coverage on PR
        if: github.event_name == 'pull_request'
        uses: davelosert/vitest-coverage-report-action@v2

  # ─────────────────────────────────────────
  # STAGE 2 — Build Verification
  # Confirms Next.js builds cleanly before
  # Vercel picks it up — fails fast on errors.
  # ─────────────────────────────────────────
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Next.js
        run: pnpm build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          # Provide a dummy DB URL so Drizzle doesn't error at build time
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

  # ─────────────────────────────────────────
  # STAGE 3 — Security Scanning (parallel)
  # All three run at the same time after
  # the quality gate passes.
  # ─────────────────────────────────────────
  security-sast:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Run Semgrep
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/typescript
            p/nextjs
            p/react
            p/owasp-top-ten
            p/xss
            p/sql-injection
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  security-dependencies:
    name: Dependency Audit
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Fails on HIGH or CRITICAL severity CVEs (production deps only)
      - name: pnpm audit
        run: pnpm audit --prod --audit-level=high

  security-secrets:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git log scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ─────────────────────────────────────────
  # STAGE 4 — Migration Check (on main only)
  # Dry-run Drizzle migrations to validate
  # schema changes before they reach prod.
  # ─────────────────────────────────────────
  migration-check:
    name: Migration Dry-Run
    runs-on: ubuntu-latest
    needs: [build, security-sast, security-dependencies, security-secrets]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Generates SQL without applying — validates migration files are correct
      - name: Drizzle generate check
        run: pnpm drizzle-kit generate --check
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
